{% extends 'layout.html' %}
{% load static %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center gap-4">
            <!-- Avatar -->
            <div class="position-relative">
              <img id="avatarImg" src="{% if user_obj.profile.image %}{{ user_obj.profile.image.url }}{% else %}{% static 'img/default-avatar.png' %}{% endif %}" alt="Аватар" class="rounded-circle img-thumbnail" style="width:120px; height:120px; object-fit:cover;">
              <label for="avatarInput" class="btn btn-sm btn-outline-secondary position-absolute bottom-0 end-0" style="transform:translate(20%,20%);">Изменить</label>
              <form id="avatarForm" action="{% url 'users:update_avatar' %}" method="post" enctype="multipart/form-data" class="d-none">
                {% csrf_token %}
                <input id="avatarInput" name="avatar" type="file" accept="image/*" onchange="document.getElementById('avatarForm').submit()">
              </form>
            </div>

            <!-- Name and role -->
            <div class="flex-grow-1">
              <h4 class="mb-0">{{ user_obj.get_full_name|default:user_obj.username }}</h4>
              <p class="text-muted mb-1">{{ user_obj.profile.role|default:'Пользователь' }}</p>
              <small class="text-muted">Зарегистрирован: {{ user_obj.date_joined|date:'d.m.Y' }}</small>
            </div>

            <!-- Edit profile button (optional full-page edit) -->
            <div>
              <a href="{% url 'users:edit_profile' %}" class="btn btn-outline-primary">Редактировать профиль</a>
            </div>
          </div>

          <hr>

          <!-- Personal data -->
          <form id="profileForm" action="{% url 'users:profile_update' %}" method="post" class="row g-3">
            {% csrf_token %}

            <div class="col-md-6">
              <label class="form-label">Имя</label>
              <input type="text" name="first_name" value="{{ user_obj.first_name }}" class="form-control" readonly>
            </div>

            <div class="col-md-6">
              <label class="form-label">Фамилия</label>
              <input type="text" name="last_name" value="{{ user_obj.last_name }}" class="form-control" readonly>
            </div>

            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" name="email" value="{{ user_obj.email }}" class="form-control" readonly>
            </div>

            <div class="col-md-6">
              <label class="form-label">Телефон</label>

              <!-- phone display / edit group -->
              <div class="input-group">
                <input id="phoneInput" type="tel" name="phone" value="{{ user_obj.profile.phone|default:'' }}" class="form-control" placeholder="+7 (900) 000-00-00" disabled>
                <button id="editPhoneBtn" type="button" class="btn btn-outline-primary">Изменить</button>
                <button id="savePhoneBtn" type="submit" class="btn btn-primary d-none">Сохранить</button>
                <button id="cancelPhoneBtn" type="button" class="btn btn-outline-danger d-none">Отменить</button>
              </div>
              <div class="form-text">Телефон можно изменить по необходимости. Формат: +7XXXXXXXXXX</div>
            </div>
            <div class="col-12 d-flex justify-content-end">
              <a href="{% url 'users:change_password' %}" class="btn btn-outline-primary">Сменить пароль</a>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Toggle phone field editability
  const editBtn = document.getElementById('editPhoneBtn');
  const saveBtn = document.getElementById('savePhoneBtn');
  const cancelBtn = document.getElementById('cancelPhoneBtn');
  const phoneInput = document.getElementById('phoneInput');
  const profileForm = document.getElementById('profileForm');

  let originalPhone = phoneInput.value;

  editBtn.addEventListener('click', () => {
    phoneInput.disabled = false;
    phoneInput.focus();
    editBtn.classList.add('d-none');
    saveBtn.classList.remove('d-none');
    cancelBtn.classList.remove('d-none');
  });

  cancelBtn.addEventListener('click', () => {
    phoneInput.value = originalPhone;
    phoneInput.disabled = true;
    editBtn.classList.remove('d-none');
    saveBtn.classList.add('d-none');
    cancelBtn.classList.add('d-none');
  });

  // When form is submitted, phone will be sent together with csrf token
  profileForm.addEventListener('submit', () => {
    // optional: basic client-side validation for phone
    const phone = phoneInput.value.trim();
    if (phone && !/^\+?\d{7,15}$/.test(phone.replace(/[^+\d]/g, ''))) {
      alert('Неверный формат телефона. Укажите только цифры и знак +.');
      event.preventDefault();
      return false;
    }
  });
</script>

{% endblock %}